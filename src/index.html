<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Basketball GM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <link rel="shortcut icon" href="/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="/ico/apple-touch-icon-57-precomposed.png">

    <script type="text/javascript">
      window.inCordova = document.URL.indexOf('file://') === 0;
      window.bbgmPrefix = window.inCordova ? "" : "/"; // Relative URLs for Cordova
      window.bbgmVersion = "REV_GOES_HERE";

      function loadCSS(filename){
        var el = document.createElement("link");
        el.setAttribute("rel", "stylesheet");
        el.setAttribute("href", bbgmPrefix + filename);
        document.getElementsByTagName("head")[0].appendChild(el);
      }

      loadCSS("gen/bbgm.css");

      window.enableLogging = location.host.indexOf("basketball-gm.com") >= 0 && location.pathname.indexOf("/test") === -1;

      if (window.enableLogging) {
        // Google Analytics
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-38759330-1']);
        _gaq.push(['_setDomainName', 'basketball-gm.com']);
        _gaq.push(['_trackPageview']);
        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        }());
      }
    </script>

    <script type="text/javascript">
      if (localStorage.debug !== "debug") {
        var bs = document.createElement('script');
        bs.type = 'text/javascript';
        bs.src = 'https://d2wy8f7a9ursnm.cloudfront.net/bugsnag-2.min.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(bs, s);
        if (window.Bugsnag) {
          window.Bugsnag.apiKey = "c10b95290070cb8888a7a79cc5408555";
          window.Bugsnag.appVersion = window.bbgmVersion;
          if (location.host.indexOf("localhost") === 0) {
            window.Bugsnag.releaseStage = "development";
          } else if (location.host.indexOf("beta.basketball-gm.com") === 0) {
            window.Bugsnag.releaseStage = "beta";
          } else if (location.host.indexOf("play.basketball-gm.com") === 0) {
            window.Bugsnag.releaseStage = "production";
          } else {
            window.Bugsnag.releaseStage = "unknown";
          }
          window.Bugsnag.notifyReleaseStages = ["beta", "production", "unknown"];

          // For errors inside Bluebird
          window.addEventListener("unhandledrejection", function (err) {
              window.Bugsnag.notifyException(err);
          });
        }
      }
    </script>

    <script async="async" src="https://www.googletagservices.com/tag/js/gpt.js"></script>
  </head>

  <body>
    <script type="text/javascript">
      // Banner ads
      var googletag = googletag || {};
      googletag.cmd = googletag.cmd || [];

      googletag.cmd.push(function() {
        googletag.defineSlot('/42283434/BBGM_Bottom', [[970, 90], [728, 90], [970, 250]], 'div-gpt-ad-1473268147477-0').addService(googletag.pubads());
        googletag.defineSlot('/42283434/BBGM_Top', [[970, 90], [728, 90], [970, 250]], 'div-gpt-ad-1473268147477-1').addService(googletag.pubads());
        googletag.pubads().enableSingleRequest();
        googletag.enableServices();
      });

      if (window.enableLogging) {
        // Google Consumer Surveys
        var TriggerPrompt = function(articleUrl, contentId) {
          var ARTICLE_URL = articleUrl;
          var CONTENT_ID = contentId || '';
          var el = document.createElement('script');
          var url = '//survey.g.doubleclick.net/survey?site=5945171946504192' +
                    '&url=' + encodeURIComponent(ARTICLE_URL) +
                    (CONTENT_ID ? '&cid=' + encodeURIComponent(CONTENT_ID) : '') +
                    '&random=' + (new Date).getTime() +
                    '&after=1';
          el.setAttribute('src', url);
          var head = document.getElementsByTagName('head')[0] ||
              document.getElementsByTagName('body')[0];
          head.appendChild(el);
        };

        // Survata
        (function(w, d, t, v) {
            w[v] = w[v] || {}; w[v].qr = []; w[v].qf = [];
            var got = 0, g = function() {
                if (got) { return; } got = 1;
                w[v].ft = setTimeout(function() {
                    for (var i = 0; i < w[v].qf.length ; i++) { w[v].qf[i][0].call(w[v]); }
                    w[v].f = 1; w[v].qf = [];
                    w[v].fail = function(fn) { fn.call(w[v]); return w[v]; };
                }, 5000);
                var s = d.createElement(t);
                s.src = ('https:' === d.location.protocol ? 'https:' : 'http:') + "//api.survata.net/latest/js/survata.js?cb="+((new Date().getTime())/1e3).toFixed();
                var scr = d.getElementsByTagName(t)[0], par = scr.parentNode; par.insertBefore(s, scr);
            };
            w[v].ready = function() { g(); w[v].qr.push(arguments); return w[v]; };
            w[v].fail = function() { g(); w[v].qf.push(arguments); return w[v]; };
            w[v].publisher = "ca71e3e4-0cc9-464d-aa0e-38e8d5d700f3";
        }(window, document, 'script', 'Survata'));
      }
    </script>

    <div id="content">
      <div style="max-width: 360px; margin: 0 auto;">
        <div id="loading-msg">
          <h1>Loading...</h1>

          <p style="clear: both; margin-bottom: 8em"></p>
          <div class="team-picture-splash" id="team-picture-0"></div>
          <div class="team-picture-splash" id="team-picture-1"></div>
          <div class="team-picture-splash" id="team-picture-2"></div>
          <div class="team-picture-splash" id="team-picture-3"></div>
          <div class="team-picture-splash" id="team-picture-4"></div>
          <div class="team-picture-splash" id="team-picture-5"></div>
          <div class="team-picture-splash" id="team-picture-6"></div>
          <div class="team-picture-splash" id="team-picture-7"></div>
          <div class="team-picture-splash" id="team-picture-8"></div>
          <div class="team-picture-splash" id="team-picture-9"></div>
          <div class="team-picture-splash" id="team-picture-10"></div>
          <div class="team-picture-splash" id="team-picture-11"></div>

          <p style="clear: both; margin-bottom: 8em"></p>
          <p>This should only take a few seconds on a fast connection.</p>
          <p>If this gets stuck for a while, try <a href="https://basketball-gm.com/manual/debugging/">the debugging instructions</a> and try to find an error message and report a bug.</p>
        </div>

        <hr style="margin-bottom: 1.5em">

        <footer>
          <p>
              <a href="https://basketball-gm.com/about/" rel="noopener noreferrer" target="_blank">About</a> ·
              <a href="https://basketball-gm.com/advertise/" rel="noopener noreferrer" target="_blank">Advertise</a> ·
              <a href="https://basketball-gm.com/blog/" rel="noopener noreferrer" target="_blank">Blog</a> ·
              <a href="https://basketball-gm.com/contact/" rel="noopener noreferrer" target="_blank">Contact</a> ·
              <a href="https://basketball-gm.com/share/" rel="noopener noreferrer" target="_blank">Share</a><br />
          </p>
          <p class="rev">v3.6 · REV_GOES_HERE</p>
        </footer>
      </div>
    </div>

    <iframe style="display: none;" src="/manifest_hack"></iframe>

    <script>
      function shuffle(array) {
        let counter = array.length;
        while (counter > 0) {
          let index = Math.floor(Math.random() * counter);
          counter--;
          let temp = array[counter];
          array[counter] = array[index];
          array[index] = temp;
        }
        return array;
      }

      var abbrevs = shuffle(['ATL', 'BAL', 'BOS', 'CHI', 'CIN', 'CLE', 'DAL', 'DEN', 'DET', 'HOU', 'LV', 'LA', 'MXC', 'MIA', 'MIN', 'MON', 'NYC', 'PHI', 'PHO', 'PIT', 'POR', 'SAC', 'SD', 'SF', 'SEA', 'STL', 'TPA', 'TOR', 'VAN', 'WAS']);
      for (var i = 0; i < 12; i++) {
        document.getElementById('team-picture-' + i).style.backgroundImage = 'url(/img/logos/' + abbrevs[i] + '.png)';
      }

      // Browser compatibility checks! https://gist.github.com/jensarps/15f270874889e1717b3d
      var goodIDB = function (cb) {
        if (typeof window.indexedDB === "undefined") {
          cb(false);
          return;
        }

        var idb = window.indexedDB || window.webkitIndexedDB || window.mozIndexedDB;
        var keyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.mozIDBKeyRange;

        try {
          keyRange.only([1]);
        } catch (e) {
          cb(false);
          return;
        }

        var openRequest = idb.open('__detectIDB_test', 1);

        openRequest.onupgradeneeded = function (evt) {
          var db = evt.target.result;
          db.createObjectStore('one', {
            keyPath: 'key'
          });
          db.createObjectStore('two', {
            keyPath: 'key'
          });
        };

        openRequest.onsuccess = function (evt) {
          var db = evt.target.result;
          var transaction;
          try {
            transaction = db.transaction(['one', 'two'], 'readwrite');
          } catch (e) {
            cb(false);
            return;
          }

          transaction.oncomplete = function () {
            db.close();
            cb(true);
          };
        };
      };

      goodIDB(function (result) {
        if (!result) {
          var errorMsg = '<p><b>Error!</b> Your browser is not modern enough to run Basketball GM. <a href="https://www.firefox.com/">Mozilla Firefox</a> and <a href="https://www.google.com/chrome/">Google Chrome</a> work best.</p>';

          // Special error for Apple's mobile devices, as that's the only platform that is totally unsupported (no alternative browser to install)
          if (/(iPad|iPhone|iPod)/.test(navigator.userAgent)) {
            errorMsg += '<p>If you\'re on an iPhone/iPad/iPod, there is currently no way to run Basketball GM. Please come back on a desktop/laptop or a non-Apple mobile device! And complain to Apple to fix IndexedDB if you want to play Basketball GM on your iDevice.</p>';
          }

          var loadingMsg = document.getElementById('loading-msg');
          loadingMsg.className = 'alert alert-danger';
          loadingMsg.innerHTML = errorMsg;
        } else {
          var body = document.getElementsByTagName('body').item(0);
          var script = document.createElement('script');
          script.type = 'text/javascript';
          script.src = bbgmPrefix + "gen/app.js";
          body.appendChild(script);
        }
      });
    </script>
  </body>
</html>
