{% extends "league_layout.html" %}
{% set active_page = "roster" %}

{% block title %}Roster - League {{ g.league_id }} - Basketball GM{% endblock %}

{% block league_content %}
  <script type="text/javascript">
$(document).ready(function() {
    dropdown($('#roster_select_team'), $('#roster_select_season'));

    {% if tid == g.user_tid and view_season == g.season %}
        var result = parse_league_url(document.URL);
        var league_root_url = result[1];

        // Roster reordering
        var fixHelper = function(e, ui) {
            // Return helper which preserves the width of table cells being reordered
            ui.children().each(function() {
              $(this).width($(this).width());
            });
            return ui;
        };
        $('#roster tbody').sortable({
            helper: fixHelper,
            cursor: 'move',
            update: function(e, ui) {
                sorted = $(this).sortable('serialize');
                $.post(league_root_url + '/roster/reorder', sorted, function(msg) {
                    var i = 1;
                    $('#roster tbody').children().each(function() {
                        if (i <= 5) {
                            $(this).find('td:first').removeClass('btn-info');
                            $(this).find('td:first').addClass('btn-primary');
                        }
                        else {
                            $(this).find('td:first').removeClass('btn-primary');
                            $(this).find('td:first').addClass('btn-info');
                        }
                        i++;
                    });
                });
            }
        }).disableSelection();
        $('#auto_sort_roster').click(function(event) {
            $.post(league_root_url + '/roster/auto_sort', {'json': 1}, function (data) {
                ajax_update(data);
            }, 'json');
        });

        // Release player
        $('#roster button').click(function(event) {
            if (this.dataset.action == 'release') {
                if (window.confirm('Are you sure you want to release ' + this.dataset.playerName + '?  He will become a free agent and no longer take up a roster spot on your team, but you will still have to pay his salary (and have it count against the salary cap) until his contract expires in ' + this.dataset.contractExpiration + '.')) {
                    var tr = this.parentNode.parentNode;
                    $.post('{{ url_for('roster_release', league_id=g.league_id) }}', {'pid': this.dataset.playerId}, function (data) {
                        if (data['error']) {
                            alert('Error: ' + data['error']);
                        }
                        else {
                            tr.parentNode.removeChild(tr);
                        }
                    }, 'json');
                }
            }
            else if (this.dataset.action == 'buy_out') {
                if ({{ cash }} > this.dataset.cashOwed) {
                    if (window.confirm('Are you sure you want to buy out ' + this.dataset.playerName + '? You will have to pay him the $' + this.dataset.cashOwed + 'M remaining on his contract from your current cash reserves of ${{ cash|float|round(1) }}M. He will then become a free agent and his contract will no longer count towards your salary cap.')) {
                        var tr = this.parentNode.parentNode;
                        $.post('{{ url_for('roster_buy_out', league_id=g.league_id) }}', {'pid': this.dataset.playerId}, function (data) {
                            if (data['error']) {
                                alert('Error: ' + data['error']);
                            }
                            else {
                                tr.parentNode.removeChild(tr);
                            }
                        }, 'json');
                    }
                }
                else {
                    alert('You only have ${{ cash|float|round(1) }}M in cash, but it would take $' + this.dataset.cashOwed + 'M to buy out ' + this.dataset.playerName + '.');
                }
            }
            else if (this.dataset.action == 'trade_for') {

            }
        });
    {% endif %}
});
  </script>

  <form action="{{ url_for('roster', league_id=g.league_id) }}" method="GET" class="form-inline pull-right">
    <select id="roster_select_team" name="team" class="team">
      {% for team in teams %}
        <option value="{{ team.abbrev }}"{% if team.tid == tid %} selected="selected"{% endif %}>{{ team.region }} {{ team.name }}</option>
      {% endfor %}
    </select>
    <select id="roster_select_season" name="season" class="season">
      {% for season in seasons %}
        <option value="{{ season }}"{% if season == view_season %} selected="selected"{% endif %}>{{ season }} season</option>
      {% endfor %}
    </select>
  </form>

  <h1>{{ team_name }} Roster</h1>

  {% if tid == g.user_tid and view_season == g.season %}
    <p>You currently have {% if num_roster_spots == 1 %}1 empty roster spot{% else %}{{ num_roster_spots }} empty roster spots{% endif %}.</p>
    <p>Drag and drop row handles to move players between the starting lineup (<span class="roster_gs">&#9632;</span>) and the bench (<span class="roster_bench">&#9632;</span>).</p>
    <p><button class="btn" id="auto_sort_roster">Auto sort roster</button></p>
  {% endif %}
  <p>
  <table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered table-condensed" id="roster">
  <thead>
    <tr>{% if tid == g.user_tid and view_season == g.season %}<th></th>{% endif %}<th>Name</th><th title="Position">Pos</th><th>Age</th><th title="Overall Rating">Ovr</th><th title="Potential Rating">Pot</th>{% if view_season == g.season %}<th>Contract</th>{% endif %}<th title="Minutes Per Game">Min</th><th title="Points Per Game">Pts</th><th title="Rebounds Per Game">Reb</th><th title="Assists Per Game">Ast</th>{% if tid == g.user_tid and view_season == g.season %}<th>Release</th><th>Buy out</th>{% elif view_season == g.season %}<th>Trade for</th>{% endif %}</tr>
  </thead>
  <tbody>
    {% for player in players %}
      <tr id="roster_{{ player.pid }}">{% if tid == g.user_tid and view_season == g.season %}<td class="{% if loop.index <= 5 %}btn-primary gs{% else %}btn-info bench{% endif %}"></td>{% endif %}<td><a href="{{ url_for('player_', league_id=g.league_id, pid=player.pid) }}">{{ player.name }}</a></td><td>{{ player.pos }}</td><td>{{ player.age }}</td><td>{{ player.overall }}</td><td>{{ player.pot }}</td>{% if view_season == g.season %}<td>${{ player.contract_amount|float|round(1) }}M through {{ player.contract_expiration }}</td>{% endif %}<td>{{ player.min|float|round(1) }}</td><td>{{ player.pts|float|round(1) }}</td><td>{{ player.rebounds|float|round(1) }}</td><td>{{ player.ast|float|round(1) }}</td>{% if tid == g.user_tid and view_season == g.season %}<td><button class="btn btn-mini" data-action="release" data-player-id="{{ player.pid }}" data-player-name="{{ player.name }}" data-contract-expiration="{{ player.contract_expiration }}">Release</button></td><td><button class="btn btn-mini" data-action="buy_out" data-player-id="{{ player.pid }}" data-player-name="{{ player.name }}" data-cash-owed="{{ player.cash_owed|float|round(1) }}">Buy out</button></td>{% elif view_season == g.season %}<td><button class="btn btn-mini" data-action="trade_for" data-player-id="{{ player.pid }}">Trade for</button></td>{% endif %}</tr>
    {% endfor %}
  </tbody>
  </table>
  </p>
{% endblock %}
