<script type="text/javascript">
$(document).ready(function() {
  var roster_checkboxes_other, roster_checkboxes_user;

  // Don't use the dropdown function because this needs to be a POST
  $('#trade_select_team').change(function(event) {
    Davis.location.replace(new Davis.Request({
      abbrev: $('#trade_select_team').val(),
      fullPath: "/l/{{lid}}/trade",
      method: "post"
    }));
  });

  ui.datatableSinglePage($('#roster_user'), 5, [
    {{#userRoster}}
      [ '<input name="user_pids" type="checkbox" value="{{pid}}"{{#if selected}} checked="checked"{{/if}}>', '<a href="/l/{{../lid}}/player/{{pid}}">{{name}}</a>', '{{pos}}', '{{age}}', '{{ovr}}', '{{pot}}', '${{round contractAmount 2}}M thru {{contractExp}}', '{{round min 1}}', '{{round pts 1}}', '{{round trb 1}}', '{{round ast 1}}' ],
    {{/userRoster}}
  ]);

  ui.datatableSinglePage($('#roster_other'), 5, [
    {{#otherRoster}}
      [ '<input name="other_pids" type="checkbox" value="{{pid}}"{{#if selected}} checked="checked"{{/if}}>', '<a href="/l/{{../lid}}/player/{{pid}}">{{name}}</a>', '{{pos}}', '{{age}}', '{{ovr}}', '{{pot}}', '${{round contractAmount 2}}M thru {{contractExp}}', '{{round min 1}}', '{{round pts 1}}', '{{round trb 1}}', '{{round ast 1}}' ],
    {{/otherRoster}}
  ]);

  roster_checkboxes_user = $('#roster_user input');
  roster_checkboxes_other = $('#roster_other input');

  $('#rosters input[type="checkbox"]').click(function(event) {
    var otherPids, serialized, userPids;

    serialized = $('#rosters').serializeArray();
    userPids = _.map(_.pluck(_.filter(serialized, function (o) { return o.name === "user_pids"; }), "value"), Math.floor);
    otherPids = _.map(_.pluck(_.filter(serialized, function (o) { return o.name === "other_pids"; }), "value"), Math.floor);

    $('#propose_trade button').attr('disabled', 'disabled'); // Will be reenabled, if appropriate, when the summary is loaded
    api.tradeUpdate(userPids, otherPids, function (summary, userPids, otherPids) {
      var found, i, j;

      $("#trade_summary").html(summary);
      for (i = 0; i < roster_checkboxes_user.length; i++) {
        found = false;
        for (j = 0; j < userPids.length; j++) {
          if (Math.floor(roster_checkboxes_user[i].value) === userPids[j]) {
            roster_checkboxes_user[i].checked = true;
            found = true;
            break;
          }
        }
        if (!found) {
          roster_checkboxes_user[i].checked = false;
        }
      }
      for (i = 0; i < roster_checkboxes_other.length; i++) {
        found = false;
        for (j = 0; j < otherPids.length; j++) {
          if (Math.floor(roster_checkboxes_other[i].value) === otherPids[j]) {
            roster_checkboxes_other[i].checked = true;
            found = true;
            break;
          }
        }
        if (!found) {
          roster_checkboxes_other[i].checked = false;
        }
      }
    });
  });

  $('#propose_trade button').click(function(event) {
    $('#propose_trade button').attr('disabled', 'disabled');
  });
});
</script>

<h1>Trade</h1>

<div class="row-fluid">
  <div class="span7">
    <form id="rosters">
      <p><select id="trade_select_team" name="team" class="team form-inline">
        {{#teams}}
          <option value="{{abbrev}}"{{#if selected}} selected="selected"{{/if}}}>{{region}} {{name}}</option>
        {{/teams}}
      </select>
      <table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered table-condensed" id="roster_other">
      <thead>
        <tr><th></th><th>Name</th><th title="Position">Pos</th><th>Age</th><th title="Overall Rating">Ovr</th><th title="Potential Rating">Pot</th><th>Contract</th><th title="Minutes Per Game">Min</th><th title="Points Per Game">Pts</th><th title="Rebounds Per Game">Reb</th><th title="Assists Per Game">Ast</th></tr>
      </thead>
      </table>
      </p>

      <h2>{{userTeamName}}</h2>
      <p>
      <table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered table-condensed" id="roster_user">
      <thead>
        <tr><th></th><th>Name</th><th title="Position">Pos</th><th>Age</th><th title="Overall Rating">Ovr</th><th title="Potential Rating">Pot</th><th>Contract</th><th title="Minutes Per Game">Min</th><th title="Points Per Game">Pts</th><th title="Rebounds Per Game">Reb</th><th title="Assists Per Game">Ast</th></tr>
      </thead>
      </table>
      </p>
    </form>
  </div>
  <div class="span5" id="trade_summary">
    {{{tradeSummary}}}
  </div>
</div>